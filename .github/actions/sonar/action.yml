name: "SonarCloud analysis"
description: "Run Sonar analysis"
inputs:
  SONAR_TOKEN:
    description: 'Token to auth to Sonar'
    required: true
  branch:
    description: 'Branch to scan'
    required: false
    default: "feature"
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 1.11

    - name: Install SonarCloud scanners
      run: |
        dotnet tool install --global dotnet-sonarscanner
      shell: bash

    - name: Set variables for testing
      if: ${{ inputs.branch == 'feature' }}
      run: |
        echo "DB_HOST=localhost" >> $GITHUB_ENV
        echo "DB_USER=postgres" >> $GITHUB_ENV
        echo "DB_PASSWORD=ingoodhands" >> $GITHUB_ENV
        echo "DB_DATABASE=in_good_hands" >> $GITHUB_ENV
        echo "DB_PORT=5432" >> $GITHUB_ENV
        echo "OAUTH2_AUTHORITY=dummy" = >> $GITHUB_ENV
        echo "OAUTH2_AUDIENCE=dummy" = >> $GITHUB_ENV
        echo "OAUTH2_CLIENT_ID=dummy" = >> $GITHUB_ENV
        echo "OAUTH2_SCOPES=dummy" = >> $GITHUB_ENV
        echo "FRONTEND_URL=dummy" = >> $GITHUB_ENV
        echo "HASHIDS_SALT=dummy" = >> $GITHUB_ENV
      shell: bash

    - name: Run backend and postgres for testing
      if: ${{ inputs.branch == 'feature' }}
      run: |
        docker-compose -f docker-compose.ci.yml up -d
      shell: bash

    - name: Run tests
      if: ${{ inputs.branch == 'feature' }}
      run: |
        dotnet test --collect:"XPlat Code Coverage" --results-directory ./coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
      shell: bash
      working-directory: src/backend

    - name: Download coverage report
      if: ${{ inputs.branch != 'feature' }}
      uses: dawidd6/action-download-artifact@v2
      with:
        name: coverage
        path: .
        workflow: build-test-all.yml

    - name: Move coverage report
      if: ${{ inputs.branch != 'feature' }}
      shell: bash
      run: |
        find . -name "coverage.opencover.xml" -exec sh -c 'for f; do d=${f%/*}; mv -- "$f" "./src/backend/${d#./}${f##*/}"; done' findsh {} +

    - name: Build and analyze
      run: |
        reports=$(find . -type f -name "*coverage.opencover.xml" | xargs -n1 -I{} basename "{}" | tr '\n' ',')
        dotnet-sonarscanner begin /k:"PJATK-SPK_ingoodhands" /o:"pjatk-spk" /d:sonar.login="${{ inputs.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.cs.opencover.reportsPaths=$reports
        dotnet build --no-incremental
        dotnet-sonarscanner end /d:sonar.login="${{ inputs.SONAR_TOKEN }}"
      shell: bash
      working-directory: src/backend
